<script>
    const generateBtn = document.getElementById('generate-btn');
    const endBtn = document.getElementById('end-btn');
    const reportBtn = document.getElementById('report-btn');
    const spinner = document.getElementById('spinner');
    const statusEl = document.getElementById('status');
    const resultsGrid = document.getElementById('results-grid');

    function downloadFile(url) {
        if (!url || typeof url !== "string") {
            console.error("Invalid download URL:", url);
            statusEl.textContent = "❌ 錯誤：回傳的下載連結無效。";
            return;
        }
        const filename = url.split('/').pop() || "download";
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // --- 步驟 1: 生成預覽 ---
    generateBtn.addEventListener('click', async () => {
        const applicantName = document.getElementById('applicant_name').value;
        if (!applicantName) {
            alert('請先填寫 申請人名稱！');
            return;
        }

        const payload = {
            prompt: document.getElementById('prompt').value,
            seed: document.getElementById('seed').value,
            width: document.getElementById('width').value,
            height: document.getElementById('height').value,
        };
        if (!payload.prompt) {
            alert('請填寫 Prompt！');
            return;
        }

        spinner.style.display = 'block';
        statusEl.textContent = '正在生成預覽圖...';
        generateBtn.disabled = true;

        try {
            const response = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const result = await response.json();

            if (response.ok && result.preview_url) {
                statusEl.textContent = `✅ 版本 ${result.version} 預覽圖生成成功。`;
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `<img src="${result.preview_url}" alt="Preview ${result.version}"><p>版本 ${result.version}</p>`;
                resultsGrid.appendChild(card);
                endBtn.disabled = false;
            } else {
                throw new Error(result.error || '預覽圖生成失敗');
            }
        } catch (error) {
            console.error(error);
            statusEl.textContent = `❌ 錯誤: ${error.message}`;
        } finally {
            spinner.style.display = 'none';
            generateBtn.disabled = false;
        }
    });

    // --- 步驟 2: 結束並下載證據 ---
    endBtn.addEventListener('click', async () => {
        const applicantName = document.getElementById('applicant_name').value;
        if (!applicantName) {
            alert('請確認 申請人名稱 已填寫！');
            return;
        }

        spinner.style.display = 'block';
        statusEl.textContent = '正在結束任務並封裝所有證據...';
        endBtn.disabled = true;
        generateBtn.disabled = true;

        try {
            const response = await fetch('/finalize_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ applicant_name: applicantName }),
            });
            const result = await response.json();

            if (response.ok && Array.isArray(result.image_urls)) {
                statusEl.textContent = '✅ 證據已產出！將自動下載所有原圖...';
                result.image_urls.forEach(url => downloadFile(url));
                reportBtn.disabled = false;
            } else {
                throw new Error(result.error || '結束任務失敗');
            }
        } catch (error) {
            console.error(error);
            statusEl.textContent = `❌ 錯誤: ${error.message}`;
            endBtn.disabled = false;
            generateBtn.disabled = false;
        } finally {
            spinner.style.display = 'none';
        }
    });

    // --- 步驟 3: 下載 PDF 報告 ---
    reportBtn.addEventListener('click', async () => {
        spinner.style.display = 'block';
        statusEl.textContent = '正在生成 PDF 報告...';
        reportBtn.disabled = true;

        try {
            const response = await fetch('/create_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });
            const result = await response.json();

            if (response.ok && result.report_url) {
                statusEl.textContent = 'PDF 報告生成完畢，即將下載。';
                downloadFile(result.report_url);
            } else {
                throw new Error(result.error || '報告生成失敗');
            }
        } catch (error) {
            console.error(error);
            statusEl.textContent = `❌ 錯誤: ${error.message}`;
        } finally {
            spinner.style.display = 'none';
            reportBtn.disabled = false;
        }
    });
</script>
